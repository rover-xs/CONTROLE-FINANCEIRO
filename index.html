<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M20 12H4"></path></svg></button>
                            <button class="increase-btn text-green-400 hover:text-green-300 p-1.5 rounded-md transition ${isPaidOff ? 'opacity-20 cursor-not-allowed' : 'hover:bg-gray-700'}" data-id="${acq.id}" ${isPaidOff ? 'disabled' : ''} title="Pagar Parcela"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg></button>
                            <button class="edit-btn text-blue-400 hover:text-blue-300 p-1.5 rounded-md transition hover:bg-gray-700" data-id="${acq.id}" data-type="acquisition" title="Editar"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg></button>
                            <button class="delete-btn text-red-500 hover:text-red-400 p-1.5 rounded-md transition hover:bg-gray-700" data-id="${acq.id}" data-type="acquisition" title="Excluir"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button>
                        </div>
                    </td>
                `;
                body.appendChild(row);
            });
        };

        const renderFixedExpenses = (expenses) => {
            const body = document.getElementById('fixed-expenses-table-body');
            body.innerHTML = '';
             if (expenses.length === 0) {
                 body.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-gray-500">NENHUMA DESPESA FIXA ADICIONADA.</td></tr>`;
                 return;
            }
            expenses.forEach(exp => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700/50 text-sm';
                row.innerHTML = `
                    <td class="p-4 font-semibold">${exp.name}</td>
                    <td class="p-4 font-medium text-gray-400">${exp.destino || 'N/A'}</td>
                    <td class="p-4 text-right font-mono">${formatCurrency(exp.value)}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center items-center gap-1.5">
                           <button class="edit-btn text-blue-400 hover:text-blue-300 p-1.5 rounded-md transition hover:bg-gray-700" data-id="${exp.id}" data-type="expense" title="Editar"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg></button>
                           <button class="delete-btn text-red-500 hover:text-red-400 p-1.5 rounded-md transition hover:bg-gray-700" data-id="${exp.id}" data-type="expense" title="Excluir"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button>
                        </div>
                    </td>
                `;
                body.appendChild(row);
            });
        };

        const updateTotals = () => {
            const monthlyInstallments = localAcquisitions.filter(acq => acq.paidInstallments < acq.totalInstallments).reduce((sum, acq) => sum + acq.installmentValue, 0);
            const monthlyExpenses = localExpenses.reduce((sum, exp) => sum + exp.value, 0);
            document.getElementById('total-installments').textContent = formatCurrency(monthlyInstallments);
            document.getElementById('total-fixed-expenses').textContent = formatCurrency(monthlyExpenses);
            document.getElementById('grand-total').textContent = formatCurrency(monthlyInstallments + monthlyExpenses);
        };
        
        document.getElementById('toggle-acquisition-form').addEventListener('click', () => document.getElementById('add-acquisition-form').classList.toggle('hidden'));
        document.getElementById('toggle-expense-form').addEventListener('click', () => document.getElementById('add-expense-form').classList.toggle('hidden'));
        
        document.getElementById('add-acquisition-form').addEventListener('submit', async (e) => {
            e.preventDefault(); if (!userId) return;
            const form = e.target;
            const newAcquisition = {
                name: form.querySelector('#acq-name').value.toUpperCase(),
                destino: form.querySelector('#acq-destino').value.toUpperCase(),
                installmentValue: parseFloat(form.querySelector('#acq-installment-value').value),
                totalInstallments: parseInt(form.querySelector('#acq-total-installments').value),
                paidInstallments: 0, createdAt: new Date(),
            };
            await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'acquisitions'), newAcquisition);
            form.reset(); form.classList.add('hidden');
        });

        document.getElementById('add-expense-form').addEventListener('submit', async (e) => {
            e.preventDefault(); if (!userId) return;
            const form = e.target;
            const newExpense = {
                name: form.querySelector('#exp-name').value.toUpperCase(),
                destino: form.querySelector('#exp-destino').value.toUpperCase(),
                value: parseFloat(form.querySelector('#exp-value').value),
                createdAt: new Date(),
            };
            await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'fixedExpenses'), newExpense);
            form.reset(); form.classList.add('hidden');
        });

        document.querySelector('.lg\\:col-span-2').addEventListener('click', async (e) => {
            if (!userId) return;
            const button = e.target.closest('button');
            if (!button) return;
            const { id, type } = button.dataset;
            const acq = localAcquisitions.find(a => a.id === id);
            
            if (button.classList.contains('increase-btn')) {
                if (acq && acq.paidInstallments < acq.totalInstallments) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'acquisitions', id), { paidInstallments: acq.paidInstallments + 1 });
                }
            } else if (button.classList.contains('decrease-btn')) {
                if (acq && acq.paidInstallments > 0) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'acquisitions', id), { paidInstallments: acq.paidInstallments - 1 });
                }
            } else if (button.classList.contains('edit-btn')) {
                const item = (type === 'acquisition' ? localAcquisitions : localExpenses).find(i => i.id === id);
                showEditModal(item, type);
            } else if (button.classList.contains('delete-btn')) {
                const collectionName = type === 'acquisition' ? 'acquisitions' : 'fixedExpenses';
                const item = (type === 'acquisition' ? localAcquisitions : localExpenses).find(i => i.id === id);
                showDeleteModal(`EXCLUIR ${item.name}`, 'ESTA AÇÃO NÃO PODE SER DESFEITA.', async () => {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users',userId, collectionName, id));
                });
            }
        });

        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        function showEditModal(item, type) {
            editForm.reset();
            editForm.querySelector('#edit-id').value = item.id;
            editForm.querySelector('#edit-type').value = type;
            editForm.querySelector('#edit-name').value = item.name;
            editForm.querySelector('#edit-destino').value = item.destino || '';

            const valueContainer = document.getElementById('edit-value-container');
            const installmentsContainer = document.getElementById('edit-installments-container');

            if (type === 'acquisition') {
                valueContainer.querySelector('label').textContent = "Valor da Parcela";
                valueContainer.querySelector('input').value = item.installmentValue;
                installmentsContainer.classList.remove('hidden');
                installmentsContainer.querySelector('#edit-paid-installments').value = item.paidInstallments;
                installmentsContainer.querySelector('#edit-total-installments').value = item.totalInstallments;
            } else {
                valueContainer.querySelector('label').textContent = "Valor Mensal";
                valueContainer.querySelector('input').value = item.value;
                installmentsContainer.classList.add('hidden');
            }
            editModal.classList.remove('hidden');
        }

        function hideEditModal() { editModal.classList.add('hidden'); }

        document.getElementById('edit-modal-cancel-btn').addEventListener('click', hideEditModal);
        
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editForm.querySelector('#edit-id').value;
            const type = editForm.querySelector('#edit-type').value;
            let updatedData = { 
                name: editForm.querySelector('#edit-name').value.toUpperCase(),
                destino: editForm.querySelector('#edit-destino').value.toUpperCase()
            };
            const collectionName = type === 'acquisition' ? 'acquisitions' : 'fixedExpenses';
            if (type === 'acquisition') {
                updatedData.installmentValue = parseFloat(editForm.querySelector('#edit-value').value);
                updatedData.paidInstallments = parseInt(editForm.querySelector('#edit-paid-installments').value);
                updatedData.totalInstallments = parseInt(editForm.querySelector('#edit-total-installments').value);
            } else {
                updatedData.value = parseFloat(editForm.querySelector('#edit-value').value);
            }
            await updateDoc(doc(db, 'artifacts', appId, 'users', userId, collectionName, id), updatedData);
            hideEditModal();
        });

        // --- PDF Generation ---
        document.getElementById('download-pdf-btn').addEventListener('click', () => {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                alert('A biblioteca de PDF não pôde ser carregada. Verifique sua conexão ou desative bloqueadores de anúncios e tente novamente.');
                return;
            }
            const { jsPDF } = window.jspdf;
            const docPDF = new jsPDF();
            let startY = 15;
            
            docPDF.setFont('helvetica', 'bold');
            docPDF.setFontSize(18);
            docPDF.text("RELATÓRIO FINANCEIRO", 105, startY, { align: 'center' });
            startY += 8;

            docPDF.setFontSize(10);
            docPDF.setFont('helvetica', 'normal');
            const date = new Date();
            docPDF.text(`GERADO EM: ${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR')}`, 105, startY, { align: 'center' });
            startY += 12;

            docPDF.setFontSize(12);
            docPDF.setFont('helvetica', 'bold');
            docPDF.text("RESUMO GERAL MENSAL", 14, startY);
            startY += 8;

            docPDF.setFont('helvetica', 'normal');
            docPDF.text(`TOTAL DE PARCELAS ATIVAS: ${document.getElementById('total-installments').textContent}`, 14, startY);
            startY += 7;
            docPDF.text(`TOTAL DE DESPESAS FIXAS: ${document.getElementById('total-fixed-expenses').textContent}`, 14, startY);
            startY += 7;
            docPDF.setFont('helvetica', 'bold');
            docPDF.text(`TOTAL GERAL MENSAL: ${document.getElementById('grand-total').textContent}`, 14, startY);
            startY += 15;
            
            const allDestinos = [...new Set([...localAcquisitions.map(a => a.destino || 'NÃO ESPECIFICADO'), ...localExpenses.map(e => e.destino || 'NÃO ESPECIFICADO')])];

            allDestinos.forEach(destino => {
                const acqsByDestino = localAcquisitions.filter(a => (a.destino || 'NÃO ESPECIFICADO') === destino);
                const expsByDestino = localExpenses.filter(e => (e.destino || 'NÃO ESPECIFICADO') === destino);

                if (acqsByDestino.length > 0 || expsByDestino.length > 0) {
                    docPDF.setFontSize(14);
                    docPDF.setFont('helvetica', 'bold');
                    docPDF.text(`DESTINO: ${destino}`, 14, startY);
                    startY += 10;
                }

                if (acqsByDestino.length > 0) {
                    const acqHead = [['AQUISIÇÃO', 'VALOR PARCELA', 'VALOR PAGO', 'PAGAS/TOTAL', 'RESTANTE', 'TÉRMINO']];
                    const acqBody = acqsByDestino.map(acq => {
                        const paid = acq.paidInstallments || 0;
                        const total = acq.totalInstallments;
                        const remaining = total - paid;
                        const amountPaid = acq.installmentValue * paid;
                        const endDate = new Date();
                        endDate.setMonth(endDate.getMonth() + remaining - 1);
                        return [
                            acq.name,
                            formatCurrency(acq.installmentValue),
                            formatCurrency(amountPaid),
                            `${paid}/${total}`,
                            formatCurrency(acq.installmentValue * remaining),
                            remaining <= 0 ? 'FINALIZADO' : formatDate(endDate)
                        ];
                    });
                    docPDF.autoTable({
                        head: acqHead, body: acqBody, startY: startY,
                        headStyles: { fillColor: [41, 128, 185], fontSize: 8 },
                        bodyStyles: { fontSize: 8 },
                        theme: 'striped'
                    });
                    startY = docPDF.autoTable.previous.finalY;
                }
                
                if (expsByDestino.length > 0) {
                     if (acqsByDestino.length > 0) startY += 5;
                    const expHead = [['DESPESA FIXA', 'VALOR MENSAL']];
                    const expBody = expsByDestino.map(exp => [ exp.name, formatCurrency(exp.value) ]);
                    docPDF.autoTable({
                        head: expHead, body: expBody, startY: startY,
                        headStyles: { fillColor: [39, 174, 96], fontSize: 8 },
                        bodyStyles: { fontSize: 8 },
                        theme: 'striped'
                    });
                    startY = docPDF.autoTable.previous.finalY;
                }

                const totalParcelasMensaisDestino = acqsByDestino
                    .filter(acq => acq.paidInstallments < acq.totalInstallments)
                    .reduce((sum, acq) => sum + acq.installmentValue, 0);
                const totalDespesasFixas = expsByDestino.reduce((sum, exp) => sum + exp.value, 0);
                
                startY += 8;
                docPDF.setFontSize(9);
                docPDF.setFont('helvetica', 'bold');
                docPDF.text(`TOTAL DE PARCELAS MENSAIS (DESTINO): ${formatCurrency(totalParcelasMensaisDestino)}`, 14, startY);
                startY += 6;
                docPDF.text(`TOTAL EM DESPESAS FIXAS (DESTINO): ${formatCurrency(totalDespesasFixas)}`, 14, startY);
                startY += 10;
            });

            const today = new Date().toISOString().slice(0, 10);
            docPDF.save(`relatorio-financeiro-${today}.pdf`);
        });

    </script>
</body>
</html>"
